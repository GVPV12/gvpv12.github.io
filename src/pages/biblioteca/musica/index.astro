---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';

const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/img/musica/*.{jpg,jpeg,png,webp,avif,PNG,JPG,JPEG,WEBP,AVIF}',
  { eager: true }
);

function getImage(file: string): ImageMetadata | null {
  const key = Object.keys(allImages).find((k) => {
    const filename = k.split('/').pop()?.split('.')[0];
    return filename === file;
  });
  return key ? allImages[key].default : null;
}

const lovedAlbums = [
  { artist: 'Aimer',                   album: 'Best selection blanc',                   file: 'aimer (1)'           },
  { artist: 'Aimer',                   album: 'Walpurgis',                      file: 'aimer (2)'           },
  { artist: 'Aimer',                   album: 'Best Selection Noir',                            file: 'aimer (3)'           },
  { artist: 'Aimer',                   album: 'Dawn',                                  file: 'aimer (4)'           },
  { artist: 'Aimer',                   album: 'Daydream',                              file: 'aimer (5)'           },
  { artist: 'Nagi Yanagi',             album: 'Nagi no Asakura Ending themes',                           file: 'nagi (2)'            },
  { artist: 'Nagi Yanagi',             album: 'Euaru',                           file: 'nagi (3)'            },
  { artist: 'EGOIST',                album: 'Extra terrestrial biological entities',                              file: 'extraterrestrialost'        },
  { artist: 'Cecile Corbel',                album: 'Arrietty OST',                              file: 'arriettyost'        },
  { artist: 'Jun Maeda',                album: 'Angel Beats OST',                              file: 'angelbeatsost'        },
  { artist: 'Imagine Dragons',         album: 'Night visions',                       file: 'imagine'             },
  { artist: 'Kow Otani',     album: 'Haibane Renmei OST',                                  file: 'haibaneost'                },
  { artist: 'Celtic Woman',            album: 'Songs from the heart',                          file: 'celticwoman (1)'     },
  { artist: 'Celtic Woman',            album: 'Believe',                          file: 'celticwoman (2)'     },
  { artist: 'Aurora',                  album: 'All My Demons Greeting Me as a Friend', file: 'allmydemons'         },
  { artist: 'Aurora',                  album: 'Infections of a Different Kind',        file: 'infections-aurora'   },
];

const STATSFM_USER = 'gvpv12';

async function getRecentAlbumsFromStreams() {
  try {
    const response = await fetch(
      `https://api.stats.fm/api/v1/users/${STATSFM_USER}/streams/recent?limit=200`,
      { headers: { 'Accept': 'application/json' } }
    );
    if (!response.ok) return [];
    const data = await response.json();
    const items = data.items || [];
    const albumMap = new Map();
    items.forEach(stream => {
      const track = stream.track;
      if (!track || !track.albums || track.albums.length === 0) return;
      const album = track.albums[0];
      const albumId = album.id;
      if (albumMap.has(albumId)) {
        albumMap.get(albumId).streams++;
      } else {
        albumMap.set(albumId, {
          name: album.name,
          artist: track.artists?.[0]?.name || 'Unknown Artist',
          image: album.image,
          url: album.externalUrls?.spotify || '#',
          streams: 1
        });
      }
    });
    return Array.from(albumMap.values()).sort((a, b) => b.streams - a.streams).slice(0, 24);
  } catch { return []; }
}

async function getTopTracks() {
  try {
    const response = await fetch(
      `https://api.stats.fm/api/v1/users/${STATSFM_USER}/top/tracks?range=weeks`,
      { headers: { 'Accept': 'application/json' } }
    );
    if (!response.ok) return [];
    const data = await response.json();
    const items = data.items || [];
    return items.slice(0, 50).map(item => {
      const track = item.track;
      const artist = track.artists?.[0] || {};
      const album = track.albums?.[0] || {};
      return {
        name: track.name,
        artist: artist.name,
        image: album.image,
        url: track.externalUrls?.spotify || '#',
        playcount: item.streams || 0
      };
    });
  } catch { return []; }
}

let recentAlbums = [];
let topTracks = [];

if (STATSFM_USER && STATSFM_USER !== 'tu_username_statsfm') {
  recentAlbums = await getRecentAlbumsFromStreams();
  topTracks = await getTopTracks();
}

const lovedAlbumsConImagen = lovedAlbums.map((a) => ({ ...a, cover: getImage(a.file) }));
---

<BaseLayout
  title="M√∫sica"
  description="Mi colecci√≥n musical y estad√≠sticas de escucha"
>
  <div class="container">
    <main>
      <h1 class="text-3xl font-bold mb-2">M√∫sica</h1>
      <p class="text-zinc-700 dark:text-zinc-300 text-sm mb-10">Mi colecci√≥n musical personal y lo que he estado escuchando recientemente.</p>

      <!-- Secci√≥n 1: √Ålbumes favoritos -->
      <section class="section-block">
        <div class="section-header">
          <h2 class="text-2xl font-bold text-cyan-400">üéµ √Ålbumes que amo desde siempre</h2>
          <a href="/biblioteca/musica/albumes" class="ver-todos-link">
            ver todos mis √°lbumes favoritos ‚Üí
          </a>
        </div>
        <div class="music-grid">
          {lovedAlbumsConImagen.map((album) =>
            album.cover
              ? <div class="album-cover" title={`${album.artist} - ${album.album}`}>
                  <Image src={album.cover} alt={`${album.artist} - ${album.album}`} width={200} height={200} loading="lazy" />
                  <div class="album-overlay">
                    <p class="album-name">{album.album}</p>
                    <p class="artist-name">{album.artist}</p>
                  </div>
                </div>
              : null
          )}
        </div>
      </section>

      <!-- Secci√≥n 2: √Ålbumes recientes de Spotify -->
      <section class="section-block">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">üìÄ √Ålbumes que m√°s escucho recientemente</h2>
        {recentAlbums.length > 0 ? (
          <div class="music-grid">
            {recentAlbums.map((album) => (
              <a href={album.url} target="_blank" rel="noopener noreferrer" class="album-cover" title={`${album.artist} - ${album.name}`}>
                <img src={album.image} alt={`${album.artist} - ${album.name}`} />
                <div class="album-overlay">
                  <p class="album-name">{album.name}</p>
                  <p class="artist-name">{album.artist}</p>
                  <p class="playcount">{album.streams} streams</p>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="api-placeholder">
            <p class="text-zinc-500 dark:text-zinc-400 mb-2">
              {STATSFM_USER === 'tu_username_statsfm'
                ? 'Conecta tu cuenta de stats.fm para ver tus √°lbumes recientes aqu√≠.'
                : 'Cargando √°lbumes... Si no aparecen, verifica tu username de stats.fm.'}
            </p>
            <a href="https://stats.fm" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline inline-block">
              Crear cuenta en stats.fm (gratis) ‚Üí
            </a>
          </div>
        )}
      </section>

      <!-- Secci√≥n 3: Canciones m√°s escuchadas -->
      <section class="section-block">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">üéß Canciones m√°s escuchadas</h2>
        {topTracks.length > 0 ? (
          <div class="music-grid">
            {topTracks.map((track) => (
              <a href={track.url} target="_blank" rel="noopener noreferrer" class="album-cover" title={`${track.artist} - ${track.name}`}>
                <img src={track.image} alt={`${track.artist} - ${track.name}`} />
                <div class="album-overlay">
                  <p class="album-name">{track.name}</p>
                  <p class="artist-name">{track.artist}</p>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="api-placeholder">
            <p class="text-zinc-500 dark:text-zinc-400 mb-2">Conecta tu cuenta de stats.fm para ver tus canciones m√°s escuchadas aqu√≠.</p>
            <a href="https://stats.fm" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline inline-block">
              Crear cuenta en stats.fm (gratis) ‚Üí
            </a>
          </div>
        )}
      </section>
    </main>
  </div>
</BaseLayout>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .section-block {
    margin-bottom: 4rem;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .ver-todos-link {
    font-size: 0.8rem;
    color: #67e8f9;
    text-decoration: underline;
    opacity: 0.8;
    transition: opacity 0.2s;
    white-space: nowrap;
  }

  .ver-todos-link:hover { opacity: 1; }

  .music-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 1rem;
  }

  .album-cover {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    overflow: hidden;
    border-radius: 0.375rem;
    background-color: #f0f0f0;
    cursor: default;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: block;
  }

  /* Las secciones de stats.fm s√≠ son clickeables */
  a.album-cover { cursor: pointer; }

  :global(.dark) .album-cover { background-color: #2a2a2a; }

  .album-cover:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
  }

  .album-cover :global(img),
  .album-cover img {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .album-overlay {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
    padding: 0.75rem 0.5rem 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .album-cover:hover .album-overlay { opacity: 1; }

  .album-name {
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .artist-name {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.8);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .playcount {
    font-size: 0.6rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.25rem;
  }

  .api-placeholder {
    padding: 3rem;
    text-align: center;
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: 0.75rem;
    border: 2px dashed rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .api-placeholder {
    background-color: rgba(255, 255, 255, 0.02);
    border-color: rgba(255, 255, 255, 0.1);
  }

  @media (max-width: 1400px) { .music-grid { grid-template-columns: repeat(6, 1fr); } }
  @media (max-width: 1024px) { .music-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 768px)  { .music-grid { grid-template-columns: repeat(4, 1fr); gap: 0.75rem; } .section-header { flex-direction: column; gap: 0.5rem; } }
  @media (max-width: 480px)  { .music-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; } }
</style>